{% extends "base.html" %}

{% block title %}Nova Cultura - Passo 3{% endblock %}

{% block head %}
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="cache-version" content="{{ cache_version }}">
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-green-50 to-green-100 flex items-center justify-center px-4">
    <div class="max-w-2xl w-full">
        <!-- Progress Bar -->
        <div class="mb-8">
            <div class="flex justify-between items-center mb-2">
                <span class="text-sm font-medium text-green-600">Passo 3 de 5</span>
                <span class="text-sm text-gray-500">60%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-green-600 h-2 rounded-full" style="width: 60%"></div>
            </div>
        </div>

        <!-- Calendar Setup Card -->
        <div class="bg-white rounded-lg shadow-xl p-8">
            <!-- Header -->
            <div class="text-center mb-6">
                <div class="mx-auto h-16 w-16 bg-green-100 rounded-full flex items-center justify-center mb-4">
                    <svg class="h-8 w-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-gray-900 mb-2">
                    Configure o Calend√°rio üìÖ
                </h1>
                <p class="text-gray-600">
                    Defina as datas de plantio e colheita da sua cultura
                </p>
            </div>

            <!-- Resumo das Etapas Anteriores -->
            <div id="resumo-anterior" class="bg-gray-50 rounded-lg p-4 mb-6">
                <h3 class="font-medium text-gray-900 mb-2">üìã Resumo do Planejamento:</h3>
                <div id="resumo-conteudo" class="text-sm text-gray-600">
                    Carregando...
                </div>
            </div>

            <!-- Form -->
            <form id="wizardStep3Form">
                <div class="space-y-6">
                    <!-- Data de Plantio -->
                    <div>
                        <label for="data_plantio" class="block text-sm font-medium text-gray-700 mb-2">
                            Data de Plantio *
                        </label>
                        <input type="date" id="data_plantio" name="data_plantio" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <p class="mt-1 text-xs text-gray-500">
                            Quando voc√™ pretende plantar esta cultura
                        </p>
                    </div>

                    <!-- Ciclo da Cultura (Autom√°tico) -->
                    <div>
                        <label for="ciclo_dias" class="block text-sm font-medium text-gray-700 mb-2">
                            Ciclo da Cultura (dias)
                        </label>
                        <div class="flex">
                            <input type="number" id="ciclo_dias" name="ciclo_dias"
                                   min="1" max="365" readonly
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-l-md bg-gray-50 text-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                   placeholder="Ser√° calculado automaticamente">
                            <span class="inline-flex items-center px-3 py-2 border border-l-0 border-gray-300 bg-gray-50 text-gray-500 text-sm rounded-r-md">
                                dias
                            </span>
                        </div>
                        <p class="mt-1 text-xs text-gray-500">
                            üìä Calculado automaticamente com base nas caracter√≠sticas espec√≠ficas da cultura
                        </p>
                        
                        <!-- Informa√ß√£o sobre o ciclo espec√≠fico -->
                        <div id="info-ciclo" class="mt-2 hidden bg-green-50 border border-green-200 rounded-lg p-3">
                            <div class="text-sm text-green-800">
                                üéØ <span id="ciclo-info-texto">Ciclo espec√≠fico desta cultura ser√° exibido aqui</span>
                            </div>
                        </div>
                    </div>

                    <!-- Data de Colheita Prevista -->
                    <div>
                        <label for="data_colheita_prevista" class="block text-sm font-medium text-gray-700 mb-2">
                            Data de Colheita Prevista
                        </label>
                        <input type="date" id="data_colheita_prevista" name="data_colheita_prevista"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                               readonly>
                        <p class="mt-1 text-xs text-gray-500">
                            Calculada automaticamente com base na data de plantio e ciclo
                        </p>
                    </div>

                    <!-- Condi√ß√µes Clim√°ticas Autom√°ticas -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            Condi√ß√µes Clim√°ticas
                        </label>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="text-sm text-blue-800">
                                üìä As condi√ß√µes clim√°ticas ser√£o calculadas automaticamente com base na data de plantio selecionada e nas caracter√≠sticas espec√≠ficas da cultura.
                            </div>
                        </div>
                        
                        <!-- Campos ocultos para armazenar os dados calculados -->
                        <input type="hidden" id="estacao_plantio" name="estacao_plantio">
                        <input type="hidden" id="temp_min" name="temp_min">
                        <input type="hidden" id="temp_max" name="temp_max">
                    </div>

                    <!-- Fases da Cultura -->
                    <div class="border-t pt-6">
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            Fases Principais do Cultivo
                        </label>
                        <div id="fases-cultivo" class="space-y-3">
                            <!-- As fases ser√£o calculadas automaticamente -->
                        </div>
                    </div>

                    <!-- Alertas e Recomenda√ß√µes -->
                    <div id="alertas-calendario" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <h4 class="font-medium text-yellow-900 mb-2">‚ö†Ô∏è Alertas</h4>
                        <div id="alertas-conteudo"></div>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="flex justify-between mt-8">
                    <a href="{{ url_for('culture.culture_wizard', step='2') }}" 
                       class="px-6 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition duration-200">
                        Voltar
                    </a>
                    <button type="submit"
                            class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-200">
                        Pr√≥ximo: Recursos
                    </button>
                </div>
            </form>
        </div>

        <!-- Calendar Preview -->
        <div class="mt-6">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h4 class="font-medium text-blue-900 mb-2">üìà Cronograma Visual</h4>
                <div id="cronograma-visual" class="text-sm text-blue-800">
                    Selecione uma data de plantio para ver o cronograma completo
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script nonce="{{ g.csp_nonce }}">
// Cache busting version: {{ cache_version }}
// Force browser refresh - wizard step 3 functionality
let dadosCultura = {};

// Sugest√µes de ciclo por tipo de cultura
const ciclosPorTipo = {
    'hortalica': [30, 45, 60, 75, 90],
    'arvore_frutifera': [365, 730, 1095],
    'erva_aromatica': [45, 60, 75],
    'cereal': [90, 120, 150],
    'leguminosa': [60, 75, 90, 120],
    'tuberculo': [90, 120, 150]
};

// Temperaturas ideais por clima
const temperaturasPorClima = {
    'Temperado': { min: 15, max: 25 },
    'Mediterr√¢nico': { min: 18, max: 28 },
    'Fresco': { min: 10, max: 20 },
    'Quente e h√∫mido': { min: 20, max: 30 },
    'Quente e seco': { min: 22, max: 32 },
    'Seco e ensolarado': { min: 20, max: 30 },
    'H√∫mido e fresco': { min: 12, max: 22 },
    'Frio e seco': { min: 5, max: 15 }
};

// Temperaturas sazonais para Portugal (hemisf√©rio norte)
const temperaturasPortugalPorEstacao = {
    'primavera': { min: 12, max: 20, descricao: 'Primavera em Portugal' },
    'verao': { min: 20, max: 30, descricao: 'Ver√£o em Portugal' },
    'outono': { min: 15, max: 22, descricao: 'Outono em Portugal' },
    'inverno': { min: 5, max: 15, descricao: 'Inverno em Portugal' }
};

// Carregar dados das etapas anteriores
async function carregarResumo() {
    try {
        // Tentar carregar dados do servidor primeiro
        const response = await fetch('{{ url_for("culture.get_wizard_data") }}');
        const result = await response.json();
        let data = result.data || {};
        
        console.log('DEBUG: Dados do servidor:', data);
        
        // FALLBACK: Se servidor n√£o tem dados, tentar localStorage
        if (!data.nome) {
            console.log('DEBUG: Dados do servidor vazios, tentando localStorage...');
            const localData = localStorage.getItem('culture_wizard_backup');
            if (localData) {
                try {
                    data = JSON.parse(localData);
                    console.log('DEBUG: Dados recuperados do localStorage:', data);
                } catch (e) {
                    console.error('Erro ao parser localStorage:', e);
                }
            }
        }
        
        dadosCultura = data;
        
        if (data.nome) {
            const resumoDiv = document.getElementById('resumo-conteudo');
            resumoDiv.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <p><strong>Cultura:</strong> ${data.nome}</p>
                        <p><strong>Tipo:</strong> ${data.tipo || 'N√£o especificado'}</p>
                        ${data.variedade ? `<p><strong>Variedade:</strong> ${data.variedade}</p>` : ''}
                    </div>
                    <div>
                        <p><strong>√Årea:</strong> ${data.area_plantada ? data.area_plantada + ' m¬≤' : 'N√£o especificada'}</p>
                        <p><strong>Localiza√ß√£o:</strong> ${data.localizacao || 'N√£o especificada'}</p>
                    </div>
                </div>
            `;
            
            // Primeiro tentar usar dados espec√≠ficos da cultura do sessionStorage
            await aplicarDadosEspecificosCulturaAvancado(data.nome, data.tipo);
            
            // Preencher temperaturas ideais baseadas no clima da cultura
            preencherTemperaturasIdeais(data);
        } else {
            // Se ainda n√£o temos dados, mostrar erro mais detalhado
            console.error('DEBUG: Nenhum dado encontrado nem no servidor nem no localStorage');
            const resumoDiv = document.getElementById('resumo-conteudo');
            resumoDiv.innerHTML = `
                <div class="text-red-600">
                    <p><strong>‚ö†Ô∏è Dados n√£o encontrados</strong></p>
                    <p class="text-sm">Por favor, volte aos passos anteriores para inserir os dados.</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Erro ao carregar resumo:', error);
        
        // Fallback final: tentar localStorage
        const localData = localStorage.getItem('culture_wizard_backup');
        if (localData) {
            try {
                const data = JSON.parse(localData);
                dadosCultura = data;
                console.log('DEBUG: Usando dados de emerg√™ncia do localStorage');
                // Repetir l√≥gica de renderiza√ß√£o
                if (data.nome) {
                    const resumoDiv = document.getElementById('resumo-conteudo');
                    resumoDiv.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p><strong>Cultura:</strong> ${data.nome} (backup)</p>
                                <p><strong>Tipo:</strong> ${data.tipo || 'N√£o especificado'}</p>
                            </div>
                            <div>
                                <p><strong>√Årea:</strong> ${data.area_plantada ? data.area_plantada + ' m¬≤' : 'N√£o especificada'}</p>
                                <p><strong>Localiza√ß√£o:</strong> ${data.localizacao || 'N√£o especificada'}</p>
                            </div>
                        </div>
                    `;
                }
            } catch (e) {
                console.error('Erro no fallback localStorage:', e);
            }
        }
    }
}

function preencherTemperaturasIdeais(data) {
    console.log('DEBUG: Calculando temperaturas ideais automaticamente para:', data.nome);
    
    // IMPLEMENTA√á√ÉO H√çBRIDA: Calcular condi√ß√µes ideais da cultura automaticamente
    let temperaturaIdeal = null;
    
    // Primeiro, tentar usar o clima ideal espec√≠fico da cultura
    if (data.clima_ideal && temperaturasPorClima[data.clima_ideal]) {
        temperaturaIdeal = temperaturasPorClima[data.clima_ideal];
        console.log(`DEBUG: Usando clima espec√≠fico '${data.clima_ideal}' - Temp ideal: ${temperaturaIdeal.min}¬∞C - ${temperaturaIdeal.max}¬∞C`);
    } else {
        // Fallback baseado no tipo de cultura se n√£o tiver clima espec√≠fico
        const temperaturasPadrao = {
            'Hort√≠cola': { min: 15, max: 25 },
            'Arom√°tica': { min: 18, max: 28 },
            'Cereal': { min: 12, max: 22 },
            'Leguminosa': { min: 15, max: 25 }
        };
        
        if (data.categoria && temperaturasPadrao[data.categoria]) {
            temperaturaIdeal = temperaturasPadrao[data.categoria];
            console.log(`DEBUG: Usando categoria '${data.categoria}' - Temp ideal: ${temperaturaIdeal.min}¬∞C - ${temperaturaIdeal.max}¬∞C`);
        }
    }
    
    // Salvar as temperaturas ideais nos campos ocultos
    if (temperaturaIdeal) {
        document.getElementById('temp_min').value = temperaturaIdeal.min;
        document.getElementById('temp_max').value = temperaturaIdeal.max;
        console.log(`DEBUG: Temperaturas ideais calculadas e salvas: ${temperaturaIdeal.min}¬∞C - ${temperaturaIdeal.max}¬∞C`);
    } else {
        console.log('DEBUG: Nenhuma informa√ß√£o de temperatura ideal encontrada');
    }
}

function mostrarComparacaoClimatica(dataPlantio) {
    // Esta fun√ß√£o ser√° chamada quando uma data de plantio for selecionada
    if (!dataPlantio) return;
    
    const estacao = calcularEstacao(new Date(dataPlantio));
    const tempEsperada = temperaturasPortugalPorEstacao[estacao];
    const tempIdeal = {
        min: parseInt(document.getElementById('temp_min').value) || 0,
        max: parseInt(document.getElementById('temp_max').value) || 0
    };
    
    // Criar/atualizar div de compara√ß√£o clim√°tica
    let comparacaoDiv = document.getElementById('comparacao-climatica');
    if (!comparacaoDiv) {
        // Criar a div se n√£o existir
        comparacaoDiv = document.createElement('div');
        comparacaoDiv.id = 'comparacao-climatica';
        comparacaoDiv.className = 'mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg';
        
        // Inserir a an√°lise clim√°tica de forma simples
        const formContainer = document.querySelector('#wizardStep3Form .space-y-6');
        if (formContainer) {
            // Encontrar a div das condi√ß√µes clim√°ticas e inserir a an√°lise ap√≥s ela
            const condicoesDiv = formContainer.children[3]; // A 4¬™ div (√≠ndice 3) √© a das condi√ß√µes clim√°ticas
            if (condicoesDiv) {
                // Anexar no final da div de condi√ß√µes clim√°ticas
                condicoesDiv.appendChild(comparacaoDiv);
            } else {
                // Fallback: anexar no final do container
                formContainer.appendChild(comparacaoDiv);
            }
        }
    }
    
    let alertaClasse = 'text-blue-800';
    let alertaIcone = 'üìä';
    let alertaMensagem = '';
    
    // Verificar compatibilidade de temperatura (com sobreposi√ß√£o)
    const tempEsperadaMin = tempEsperada.min;
    const tempEsperadaMax = tempEsperada.max;
    const tempIdealMin = tempIdeal.min;
    const tempIdealMax = tempIdeal.max;
    
    // Verificar se h√° sobreposi√ß√£o nas faixas de temperatura
    const temSobreposicao = (tempEsperadaMin <= tempIdealMax) && (tempEsperadaMax >= tempIdealMin);
    const sobreposicaoSignificativa = temSobreposicao && 
        (Math.min(tempEsperadaMax, tempIdealMax) - Math.max(tempEsperadaMin, tempIdealMin) >= 5);
    
    const compativel = sobreposicaoSignificativa;
    
    console.log(`DEBUG: Verificando compatibilidade - Ideal: ${tempIdealMin}-${tempIdealMax}¬∞C, Esperada: ${tempEsperadaMin}-${tempEsperadaMax}¬∞C`);
    console.log(`DEBUG: Tem sobreposi√ß√£o: ${temSobreposicao}, Sobreposi√ß√£o significativa: ${sobreposicaoSignificativa}, Compat√≠vel: ${compativel}`);
    
    if (compativel) {
        alertaClasse = 'text-green-800';
        alertaIcone = '‚úÖ';
        alertaMensagem = 'Condi√ß√µes clim√°ticas favor√°veis para o plantio nesta √©poca!';
    } else if (temSobreposicao) {
        alertaClasse = 'text-amber-800';
        alertaIcone = '‚ö†Ô∏è';
        alertaMensagem = 'Condi√ß√µes clim√°ticas parcialmente adequadas. Monitore as condi√ß√µes de perto.';
    } else {
        alertaClasse = 'text-red-800';
        alertaIcone = '‚ùå';
        if (tempEsperadaMax < tempIdealMin) {
            alertaMensagem = 'Temperaturas muito baixas. Considere estufa ou prote√ß√£o t√©rmica.';
        } else if (tempEsperadaMin > tempIdealMax) {
            alertaMensagem = 'Temperaturas muito altas. Considere sombreamento e irriga√ß√£o frequente.';
        } else {
            alertaMensagem = 'Condi√ß√µes clim√°ticas desafiadoras. Planeje medidas de prote√ß√£o.';
        }
    }
    
    comparacaoDiv.innerHTML = `
        <h4 class="font-medium ${alertaClasse} mb-3">${alertaIcone} An√°lise Clim√°tica</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
            <div class="bg-white p-3 rounded border">
                <div class="font-medium text-gray-900 mb-1">üéØ Temperatura Ideal (Cultura)</div>
                <div class="text-gray-700">${tempIdealMin}¬∞C - ${tempIdealMax}¬∞C</div>
                <div class="text-xs text-gray-500 mt-1">Condi√ß√µes √≥timas para ${dadosCultura.nome || 'esta cultura'}</div>
            </div>
            <div class="bg-white p-3 rounded border">
                <div class="font-medium text-gray-900 mb-1">üå°Ô∏è Temperatura Esperada (${estacao.charAt(0).toUpperCase() + estacao.slice(1)})</div>
                <div class="text-gray-700">${tempEsperadaMin}¬∞C - ${tempEsperadaMax}¬∞C</div>
                <div class="text-xs text-gray-500 mt-1">${tempEsperada.descricao}</div>
            </div>
        </div>
        <div class="mt-3 p-2 bg-white rounded border-l-4 ${compativel ? 'border-green-400' : 'border-amber-400'}">
            <div class="text-sm ${alertaClasse}">${alertaMensagem}</div>
        </div>
    `;
    
    console.log(`DEBUG: Compara√ß√£o clim√°tica - Ideal: ${tempIdealMin}-${tempIdealMax}¬∞C, Esperada (${estacao}): ${tempEsperadaMin}-${tempEsperadaMax}¬∞C, Compat√≠vel: ${compativel}`);
}

function aplicarDadosEspecificosCultura() {
    // Recuperar dados espec√≠ficos da cultura armazenados no passo 1
    const cicloEspecifico = sessionStorage.getItem('cultura_ciclo_dias');
    
    console.log('DEBUG: Verificando dados salvos no sessionStorage');
    console.log('DEBUG: cultura_ciclo_dias =', cicloEspecifico);
    
    if (cicloEspecifico) {
        // Extrair apenas o n√∫mero dos dias
        const cicloNumero = parseInt(cicloEspecifico.replace(/\D/g, ''));
        console.log('DEBUG: Ciclo num√©rico extra√≠do =', cicloNumero);
        
        if (cicloNumero > 0) {
            document.getElementById('ciclo_dias').value = cicloNumero;
            console.log(`Aplicando ciclo espec√≠fico da cultura: ${cicloNumero} dias`);
            return true;
        }
    } else {
        console.log('DEBUG: Nenhum ciclo espec√≠fico encontrado no sessionStorage');
    }
    return false;
}

async function aplicarDadosEspecificosCulturaAvancado(nomeCultura, tipoCultura) {
    console.log('DEBUG: Iniciando busca avan√ßada para:', nomeCultura);
    
    // Primeiro tentar sessionStorage
    if (aplicarDadosEspecificosCultura()) {
        console.log('DEBUG: Dados encontrados no sessionStorage');
        mostrarSugestoesCiclo(tipoCultura);
        return;
    }
    
    // Se n√£o tiver no sessionStorage, tentar buscar na API
    if (nomeCultura) {
        console.log('DEBUG: Tentando buscar dados via API para:', nomeCultura);
        try {
            const response = await fetch('/cultures/api/verificar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ nome: nomeCultura })
            });
            
            if (response.ok) {
                const data = await response.json();
                console.log('DEBUG: Resposta da API:', data);
                console.log('DEBUG: data.dados_sugeridos:', data.dados_sugeridos);
                
                if (data.dados_sugeridos) {
                    console.log('DEBUG: Campos dispon√≠veis em dados_sugeridos:', Object.keys(data.dados_sugeridos));
                    console.log('DEBUG: data.dados_sugeridos.ciclo_dias:', data.dados_sugeridos.ciclo_dias);
                    console.log('DEBUG: data.dados_sugeridos.tempo_crescimento:', data.dados_sugeridos.tempo_crescimento);
                }
                
                // Verificar se tem tempo_crescimento (que √© o campo correto da API)
                if (data.success && data.dados_sugeridos && data.dados_sugeridos.tempo_crescimento) {
                    const tempoValor = data.dados_sugeridos.tempo_crescimento;
                    console.log(`DEBUG: tempo_crescimento bruto:`, tempoValor, typeof tempoValor);
                    
                    let cicloNumero;
                    if (typeof tempoValor === 'number') {
                        cicloNumero = tempoValor;
                    } else if (typeof tempoValor === 'string') {
                        cicloNumero = parseInt(tempoValor.replace(/\D/g, ''));
                    } else {
                        cicloNumero = parseInt(tempoValor);
                    }
                    
                    console.log(`DEBUG: tempo_crescimento processado: ${cicloNumero} dias`);
                    
                    if (cicloNumero > 0) {
                        document.getElementById('ciclo_dias').value = cicloNumero;
                        console.log(`Aplicando ciclo da API: ${cicloNumero} dias`);
                        
                        // Salvar no sessionStorage para pr√≥xima vez
                        sessionStorage.setItem('cultura_ciclo_dias', `${cicloNumero} dias`);
                        
                        // IMPORTANTE: Chamar mostrarSugestoesCiclo AP√ìS salvar os dados
                        console.log('DEBUG: Chamando mostrarSugestoesCiclo ap√≥s salvar dados');
                        mostrarSugestoesCiclo(tipoCultura);
                        return;
                    }
                }
            }
        } catch (error) {
            console.log('DEBUG: Erro ao buscar dados via API:', error);
        }
    }
    
    // Se chegou aqui, n√£o encontrou dados espec√≠ficos - usar fallback
    console.log('DEBUG: Nenhum dado espec√≠fico encontrado, usando fallback');
    mostrarSugestoesCiclo(tipoCultura);
}

function mostrarSugestoesCiclo(tipo) {
    console.log('üîç mostrarSugestoesCiclo - tipo:', tipo);
    
    // Verificar dados espec√≠ficos da cultura primeiro
    const dadosEspecificos = sessionStorage.getItem('cultura_ciclo_dias');
    console.log('üìä Dados espec√≠ficos encontrados:', dadosEspecificos);
    
    const infoCicloDiv = document.getElementById('info-ciclo');
    const cicloInfoTexto = document.getElementById('ciclo-info-texto');
    
    if (dadosEspecificos && dadosEspecificos !== 'null' && dadosEspecificos.trim() !== '') {
        // MOSTRAR INFORMA√á√ÉO SOBRE O CICLO ESPEC√çFICO
        const dias = parseInt(dadosEspecificos.replace(/\D/g, ''));
        console.log('‚úÖ Usando ciclo espec√≠fico:', dias, 'dias');
        
        if (dias > 0) {
            // Aplicar o valor no campo
            document.getElementById('ciclo_dias').value = dias;
            
            // Mostrar informa√ß√£o explicativa
            if (cicloInfoTexto) {
                cicloInfoTexto.textContent = `Ciclo espec√≠fico de ${dias} dias baseado nas caracter√≠sticas do ${dadosCultura.nome || 'desta cultura'}`;
            }
            
            // Mostrar a div de informa√ß√£o
            if (infoCicloDiv) {
                infoCicloDiv.classList.remove('hidden');
            }
            
            console.log('‚úÖ Ciclo espec√≠fico aplicado e exibido');
            return;
        }
    }
    
    // FALLBACK: Mostrar informa√ß√£o sobre sugest√µes gen√©ricas
    console.log('üí° Usando sugest√µes gen√©ricas para tipo', tipo);
    
    // Aplicar um valor padr√£o baseado no tipo
    const ciclosDefault = {
        'hortalica': 75,
        'arvore_frutifera': 365,
        'erva_aromatica': 60,
        'cereal': 120,
        'leguminosa': 90,
        'tuberculo': 120
    };
    
    const cicloDefault = ciclosDefault[tipo] || 75;
    document.getElementById('ciclo_dias').value = cicloDefault;
    
    if (cicloInfoTexto) {
        cicloInfoTexto.textContent = `Ciclo estimado de ${cicloDefault} dias baseado no tipo de cultura (${tipo})`;
    }
    
    // Mostrar a div de informa√ß√£o
    if (infoCicloDiv) {
        infoCicloDiv.classList.remove('hidden');
    }
    
    console.log('üí° Ciclo gen√©rico aplicado:', cicloDefault, 'dias');
}

function calcularDataColheita() {
    const dataPlantio = document.getElementById('data_plantio').value;
    const cicloDias = parseInt(document.getElementById('ciclo_dias').value);
    
    if (dataPlantio && cicloDias > 0) {
        const plantio = new Date(dataPlantio);
        const colheita = new Date(plantio);
        colheita.setDate(colheita.getDate() + cicloDias);
        
        document.getElementById('data_colheita_prevista').value = colheita.toISOString().split('T')[0];
        
        // Calcular esta√ß√£o
        const estacao = calcularEstacao(plantio);
        
        // Mostrar fases
        mostrarFasesCultivo(plantio, colheita, cicloDias);
        
        // Mostrar cronograma visual
        mostrarCronogramaVisual(plantio, colheita, cicloDias);
        
        // Verificar alertas
        verificarAlertas(plantio, colheita);
        
        // NOVA FUNCIONALIDADE: Mostrar compara√ß√£o clim√°tica h√≠brida
        mostrarComparacaoClimatica(dataPlantio);
    }
}

function calcularEstacao(data) {
    const mes = data.getMonth() + 1; // Janeiro = 1
    let estacao;
    
    // Esta√ß√µes para Portugal (Hemisf√©rio Norte)
    if (mes >= 12 || mes <= 2) {
        estacao = 'inverno';  // Dezembro, Janeiro, Fevereiro
    } else if (mes >= 3 && mes <= 5) {
        estacao = 'primavera'; // Mar√ßo, Abril, Maio
    } else if (mes >= 6 && mes <= 8) {
        estacao = 'verao';     // Junho, Julho, Agosto
    } else {
        estacao = 'outono';    // Setembro, Outubro, Novembro
    }
    
    console.log(`DEBUG: M√™s ${mes} -> Esta√ß√£o: ${estacao}`);
    document.getElementById('estacao_plantio').value = estacao;
    
    return estacao; // Retornar para uso em outras fun√ß√µes
}

function mostrarFasesCultivo(plantio, colheita, cicloDias) {
    const fasesDiv = document.getElementById('fases-cultivo');
    
    // Calcular fases aproximadas
    const germinacao = new Date(plantio);
    germinacao.setDate(germinacao.getDate() + Math.floor(cicloDias * 0.1));
    
    const crescimento = new Date(plantio);
    crescimento.setDate(crescimento.getDate() + Math.floor(cicloDias * 0.4));
    
    const floracao = new Date(plantio);
    floracao.setDate(floracao.getDate() + Math.floor(cicloDias * 0.7));
    
    fasesDiv.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
            <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                <div class="font-medium text-green-800 text-sm">üå± Germina√ß√£o</div>
                <div class="text-xs text-green-600">${formatarData(germinacao)}</div>
            </div>
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                <div class="font-medium text-blue-800 text-sm">üåø Crescimento</div>
                <div class="text-xs text-blue-600">${formatarData(crescimento)}</div>
            </div>
            <div class="bg-yellow-50 border border-blue-200 rounded-lg p-3">
                <div class="font-medium text-yellow-800 text-sm">üå∏ Flora√ß√£o</div>
                <div class="text-xs text-yellow-600">${formatarData(floracao)}</div>
            </div>
            <div class="bg-orange-50 border border-orange-200 rounded-lg p-3">
                <div class="font-medium text-orange-800 text-sm">ü•ï Colheita</div>
                <div class="text-xs text-orange-600">${formatarData(colheita)}</div>
            </div>
        </div>
    `;
}

function mostrarCronogramaVisual(plantio, colheita, cicloDias) {
    const cronogramaDiv = document.getElementById('cronograma-visual');
    
    const hoje = new Date();
    const diasAteColheita = Math.ceil((colheita - hoje) / (1000 * 60 * 60 * 24));
    
    cronogramaDiv.innerHTML = `
        <div class="flex items-center justify-between">
            <div class="text-center">
                <div class="font-medium">Plantio</div>
                <div class="text-xs">${formatarData(plantio)}</div>
            </div>
            <div class="flex-1 mx-4">
                <div class="bg-gradient-to-r from-green-200 via-blue-200 to-orange-200 h-2 rounded-full"></div>
                <div class="text-center text-xs mt-1">${cicloDias} dias</div>
            </div>
            <div class="text-center">
                <div class="font-medium">Colheita</div>
                <div class="text-xs">${formatarData(colheita)}</div>
            </div>
        </div>
        <div class="text-center mt-2 text-xs">
            ${diasAteColheita > 0 ? `‚è∞ Faltam ${diasAteColheita} dias para a colheita` : 'üéâ Per√≠odo de colheita!'}
        </div>
    `;
}

function verificarAlertas(plantio, colheita) {
    const alertas = [];
    const hoje = new Date();
    
    // Verificar alertas por esta√ß√£o de plantio
    const mesPlantio = plantio.getMonth() + 1;
    const estacaoPlantio = calcularEstacao(plantio);
    
    // Alertas espec√≠ficos por esta√ß√£o e tipo de cultura
    if (estacaoPlantio === 'inverno' && dadosCultura.categoria === 'Hort√≠cola') {
        alertas.push('Plantio no inverno pode reduzir o crescimento de hortali√ßas');
    } else if (estacaoPlantio === 'verao' && dadosCultura.categoria === 'Hort√≠cola') {
        alertas.push('Plantio no ver√£o requer irriga√ß√£o frequente e prote√ß√£o contra calor excessivo');
    } else if (estacaoPlantio === 'outono' && dadosCultura.categoria === 'Cereal') {
        alertas.push('Plantio no outono √© ideal para cereais de inverno');
    }
    
    // Verificar se colheita √© em per√≠odo chuvoso (ver√£o em Portugal)
    const mesColheita = colheita.getMonth() + 1;
    const estacaoColheita = calcularEstacao(colheita);
    if (estacaoColheita === 'verao') {
        alertas.push('Colheita no ver√£o - aten√ß√£o √† conserva√ß√£o dos produtos e prote√ß√£o contra calor');
    } else if (estacaoColheita === 'inverno') {
        alertas.push('Colheita no inverno - proteja contra geadas e excesso de humidade');
    }
    
    if (alertas.length > 0) {
        const alertasDiv = document.getElementById('alertas-calendario');
        const conteudoDiv = document.getElementById('alertas-conteudo');
        
        conteudoDiv.innerHTML = alertas.map(alerta => 
            `<p class="text-sm text-yellow-800">‚Ä¢ ${alerta}</p>`
        ).join('');
        
        alertasDiv.classList.remove('hidden');
    }
}

function formatarData(data) {
    return data.toLocaleDateString('pt-BR');
}

// Definir data m√≠nima como hoje
document.addEventListener('DOMContentLoaded', function() {
    const hoje = new Date().toISOString().split('T')[0];
    document.getElementById('data_plantio').min = hoje;
    
    // Adicionar event listeners para os campos
    document.getElementById('data_plantio').addEventListener('change', calcularDataColheita);
    document.getElementById('ciclo_dias').addEventListener('change', calcularDataColheita);
    
    carregarResumo();
});

// Submiss√£o do formul√°rio
document.getElementById('wizardStep3Form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = {
        step: '3',
        data_plantio: document.getElementById('data_plantio').value,
        ciclo_dias: parseInt(document.getElementById('ciclo_dias').value) || null,
        data_colheita_prevista: document.getElementById('data_colheita_prevista').value,
        estacao_plantio: document.getElementById('estacao_plantio').value,
        temp_min: parseInt(document.getElementById('temp_min').value) || null,
        temp_max: parseInt(document.getElementById('temp_max').value) || null
    };
    
    if (!formData.data_plantio) {
        alert('Por favor, selecione uma data de plantio.');
        return;
    }
    
    try {
        const response = await fetch('{{ url_for("culture.save_wizard_step") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            window.location.href = '{{ url_for("culture.culture_wizard", step="4") }}';
        } else {
            alert(result.error || 'Erro ao salvar dados');
        }
    } catch (error) {
        alert('Erro de conex√£o: ' + error.message);
    }
});
</script>
{% endblock %}
