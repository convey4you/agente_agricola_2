{% extends "base.html" %}

{% block title %}Preferências - Passo 4{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-green-50 to-green-100 flex items-center justify-center px-4">
    <div class="max-w-md w-full">
        <!-- Progress Bar -->
        <div class="mb-8">
            <div class="flex justify-between items-center mb-2">
                <span class="text-sm font-medium text-green-600">Passo 4 de 5</span>
                <span class="text-sm text-gray-500">80%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-green-600 h-2 rounded-full" style="width: 80%"></div>
            </div>
        </div>

        <!-- Preferences Card -->
        <div class="bg-white rounded-lg shadow-xl p-8">
            <div class="text-center mb-6">
                <h1 class="text-2xl font-bold text-gray-900 mb-2">
                    Suas Preferências
                </h1>
                <p class="text-gray-600">
                    Configure como você quer receber informações e alertas
                </p>
            </div>

            <form id="onboardingStep4Form">
                <input type="hidden" name="step" value="4">
                
                <div class="space-y-6">
                    <!-- Notificações -->
                    <div>
                        <h3 class="text-lg font-medium text-gray-900 mb-3">Notificações</h3>
                        <div class="space-y-3">
                            <label class="flex items-center justify-between">
                                <div>
                                    <span class="text-sm font-medium text-gray-700">Alertas Climáticos</span>
                                    <p class="text-xs text-gray-500">Previsão do tempo e alertas meteorológicos</p>
                                </div>
                                <input type="checkbox" name="notifications" value="weather" checked class="ml-2">
                            </label>
                            
                            <label class="flex items-center justify-between">
                                <div>
                                    <span class="text-sm font-medium text-gray-700">Lembretes de Tarefas</span>
                                    <p class="text-xs text-gray-500">Plantio, irrigação, colheita, etc.</p>
                                </div>
                                <input type="checkbox" name="notifications" value="tasks" checked class="ml-2">
                            </label>
                            
                            <label class="flex items-center justify-between">
                                <div>
                                    <span class="text-sm font-medium text-gray-700">Dicas do Agente IA</span>
                                    <p class="text-xs text-gray-500">Recomendações personalizadas</p>
                                </div>
                                <input type="checkbox" name="notifications" value="ai_tips" checked class="ml-2">
                            </label>
                            
                            <label class="flex items-center justify-between">
                                <div>
                                    <span class="text-sm font-medium text-gray-700">Atualizações do Sistema</span>
                                    <p class="text-xs text-gray-500">Novos recursos e melhorias</p>
                                </div>
                                <input type="checkbox" name="notifications" value="updates" class="ml-2">
                            </label>
                        </div>
                    </div>

                    <!-- Frequência de Relatórios -->
                    <div>
                        <label for="report_frequency" class="block text-sm font-medium text-gray-700 mb-2">
                            Frequência de Relatórios
                        </label>
                        <select id="report_frequency" name="report_frequency"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            <option value="daily">Diário</option>
                            <option value="weekly" selected>Semanal</option>
                            <option value="monthly">Mensal</option>
                            <option value="never">Nunca</option>
                        </select>
                    </div>

                    <!-- Horário Preferido -->
                    <div>
                        <label for="preferred_time" class="block text-sm font-medium text-gray-700 mb-2">
                            Horário Preferido para Notificações
                        </label>
                        <select id="preferred_time" name="preferred_time"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            <option value="morning">Manhã (6h às 12h)</option>
                            <option value="afternoon" selected>Tarde (12h às 18h)</option>
                            <option value="evening">Noite (18h às 22h)</option>
                            <option value="anytime">Qualquer horário</option>
                        </select>
                    </div>

                    <!-- Idioma -->
                    <div>
                        <label for="language" class="block text-sm font-medium text-gray-700 mb-2">
                            Idioma
                        </label>
                        <select id="language" name="language"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            <option value="pt-BR" selected>Português (Brasil)</option>
                            <option value="pt-PT">Português (Portugal)</option>
                            <option value="en">English</option>
                            <option value="es">Español</option>
                        </select>
                    </div>

                    <!-- Unidades de Medida -->
                    <div>
                        <h3 class="text-sm font-medium text-gray-700 mb-2">Unidades de Medida</h3>
                        <div class="space-y-2">
                            <div>
                                <label class="text-xs text-gray-600">Temperatura</label>
                                <div class="flex space-x-4 mt-1">
                                    <label class="flex items-center">
                                        <input type="radio" name="temp_unit" value="celsius" checked class="mr-1">
                                        <span class="text-sm">Celsius (°C)</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="temp_unit" value="fahrenheit" class="mr-1">
                                        <span class="text-sm">Fahrenheit (°F)</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div>
                                <label class="text-xs text-gray-600">Área</label>
                                <div class="flex space-x-4 mt-1">
                                    <label class="flex items-center">
                                        <input type="radio" name="area_unit" value="hectare" checked class="mr-1">
                                        <span class="text-sm">Hectares</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="area_unit" value="m2" class="mr-1">
                                        <span class="text-sm">Metros²</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="flex justify-between mt-8">
                    <a href="{{ url_for('auth.onboarding', step='3') }}" 
                       class="px-6 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition duration-200">
                        Voltar
                    </a>
                    <button type="submit"
                            class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-200">
                        Próximo
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script nonce="{{ g.csp_nonce }}">
    // Exponha o token CSRF para JavaScript
    window.csrfToken = "{{ csrf_token() }}";
    console.log('CSRF Token no step 4:', window.csrfToken);

    document.getElementById('onboardingStep4Form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const step = 4;
        const notifications = Array.from(document.querySelectorAll('input[name="notifications"]:checked')).map(input => input.value);

        try {
            const headers = {
                'Content-Type': 'application/json',
            };
            
            // Adicione o token CSRF se disponível
            if (window.csrfToken) {
                headers['X-CSRF-Token'] = window.csrfToken;
                console.log('Enviando token CSRF:', window.csrfToken);
            }

            const response = await fetch("{{ url_for('auth.save_onboarding') }}", {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({ step, notifications })
            });

            if (response.ok) {
                window.location.href = "{{ url_for('auth.onboarding', step=5) }}";
            } else {
                const errorData = await response.json();
                alert(errorData.error || 'Erro ao salvar dados');
            }
        } catch (error) {
            alert('Erro de conexão');
        }
    });
</script>
{% endblock %}
