{% extends "base.html" %}

{% block title %}Registro - Agente Agrícola{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8">
        <div>
            <div class="mx-auto h-12 w-12 flex items-center justify-center rounded-full bg-green-100">
                <i class="fas fa-user-plus text-green-600 text-2xl"></i>
            </div>
            <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                Crie sua conta
            </h2>
            <p class="mt-2 text-center text-sm text-gray-600">
                Ou
                <a href="{{ url_for('auth.login') }}" class="font-medium text-green-600 hover:text-green-500">
                    faça login em sua conta existente
                </a>
            </p>
        </div>
        
        <form class="mt-8 space-y-6" action="{{ url_for('auth.register') }}" method="POST">
            <div class="space-y-4">
                <!-- Campo de nome de usuário removido -->
                
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">E-mail</label>
                    <input id="email" name="email" type="email" required 
                           class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" 
                           placeholder="seu@email.com">
                </div>

                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Senha</label>
                    <input id="password" name="password" type="password" required 
                           class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" 
                           placeholder="Escolha uma senha segura">
                </div>

                <div>
                    <label for="confirm-password" class="block text-sm font-medium text-gray-700">Confirmar senha</label>
                    <input id="confirm-password" name="confirm-password" type="password" required 
                           class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" 
                           placeholder="Confirme sua senha">
                </div>

                <div>
                    <label for="nome-completo" class="block text-sm font-medium text-gray-700">Nome completo</label>
                    <input id="nome-completo" name="nome_completo" type="text" required
                           class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" 
                           placeholder="Seu nome completo">
                </div>

                <div>
                    <label for="telefone" class="block text-sm font-medium text-gray-700">Telefone</label>
                    <div class="mt-1 flex">
                        <!-- Dropdown customizado para países -->
                        <div class="relative flex-shrink-0">
                            <button type="button" id="country-dropdown-button" 
                                    class="flex items-center justify-between w-24 px-3 py-2 bg-gray-50 border border-gray-300 rounded-l-md text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                                <span id="selected-country" class="flex items-center">
                                    <span class="fi fi-pt mr-1" style="width: 20px; height: 15px;"></span>
                                    <span class="text-xs">+351</span>
                                </span>
                                <svg class="w-3 h-3 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            
                            <!-- Dropdown menu -->
                            <div id="country-dropdown-menu" class="hidden absolute z-20 w-64 mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto">
                                <div class="py-1">
                                    <!-- Países mais comuns primeiro -->
                                    <div class="px-3 py-1 text-xs font-semibold text-gray-500 bg-gray-50">Mais utilizados</div>
                                    <button type="button" class="country-option w-full text-left px-3 py-2 hover:bg-gray-100 flex items-center" data-code="+351" data-flag="fi fi-pt" data-country="PT">
                                        <span class="fi fi-pt mr-3" style="width: 24px; height: 18px;"></span>
                                        <span class="flex-1">Portugal</span>
                                        <span class="text-sm text-gray-500">+351</span>
                                    </button>
                                    <button type="button" class="country-option w-full text-left px-3 py-2 hover:bg-gray-100 flex items-center" data-code="+34" data-flag="fi fi-es" data-country="ES">
                                        <span class="fi fi-es mr-3" style="width: 24px; height: 18px;"></span>
                                        <span class="flex-1">Espanha</span>
                                        <span class="text-sm text-gray-500">+34</span>
                                    </button>
                                    <button type="button" class="country-option w-full text-left px-3 py-2 hover:bg-gray-100 flex items-center" data-code="+33" data-flag="fi fi-fr" data-country="FR">
                                        <span class="fi fi-fr mr-3" style="width: 24px; height: 18px;"></span>
                                        <span class="flex-1">França</span>
                                        <span class="text-sm text-gray-500">+33</span>
                                    </button>
                                    <button type="button" class="country-option w-full text-left px-3 py-2 hover:bg-gray-100 flex items-center" data-code="+55" data-flag="fi fi-br" data-country="BR">
                                        <span class="fi fi-br mr-3" style="width: 24px; height: 18px;"></span>
                                        <span class="flex-1">Brasil</span>
                                        <span class="text-sm text-gray-500">+55</span>
                                    </button>
                                    <button type="button" class="country-option w-full text-left px-3 py-2 hover:bg-gray-100 flex items-center" data-code="+1" data-flag="fi fi-us" data-country="US">
                                        <span class="fi fi-us mr-3" style="width: 24px; height: 18px;"></span>
                                        <span class="flex-1">EUA</span>
                                        <span class="text-sm text-gray-500">+1</span>
                                    </button>
                                    
                                    <div class="border-t border-gray-200 my-1"></div>
                                    <div class="px-3 py-1 text-xs font-semibold text-gray-500 bg-gray-50">Outros países</div>
                                    
                                    <button type="button" class="country-option w-full text-left px-3 py-2 hover:bg-gray-100 flex items-center" data-code="+49" data-flag="fi fi-de" data-country="DE">
                                        <span class="fi fi-de mr-3" style="width: 24px; height: 18px;"></span>
                                        <span class="flex-1">Alemanha</span>
                                        <span class="text-sm text-gray-500">+49</span>
                                    </button>
                                    <button type="button" class="country-option w-full text-left px-3 py-2 hover:bg-gray-100 flex items-center" data-code="+39" data-flag="fi fi-it" data-country="IT">
                                        <span class="fi fi-it mr-3" style="width: 24px; height: 18px;"></span>
                                        <span class="flex-1">Itália</span>
                                        <span class="text-sm text-gray-500">+39</span>
                                    </button>
                                    <button type="button" class="country-option w-full text-left px-3 py-2 hover:bg-gray-100 flex items-center" data-code="+44" data-flag="fi fi-gb" data-country="GB">
                                        <span class="fi fi-gb mr-3" style="width: 24px; height: 18px;"></span>
                                        <span class="flex-1">Reino Unido</span>
                                        <span class="text-sm text-gray-500">+44</span>
                                    </button>
                                    <button type="button" class="country-option w-full text-left px-3 py-2 hover:bg-gray-100 flex items-center" data-code="+31" data-flag="fi fi-nl" data-country="NL">
                                        <span class="fi fi-nl mr-3" style="width: 24px; height: 18px;"></span>
                                        <span class="flex-1">Holanda</span>
                                        <span class="text-sm text-gray-500">+31</span>
                                    </button>
                                    <button type="button" class="country-option w-full text-left px-3 py-2 hover:bg-gray-100 flex items-center" data-code="+32" data-flag="fi fi-be" data-country="BE">
                                        <span class="fi fi-be mr-3" style="width: 24px; height: 18px;"></span>
                                        <span class="flex-1">Bélgica</span>
                                        <span class="text-sm text-gray-500">+32</span>
                                    </button>
                                    <button type="button" class="country-option w-full text-left px-3 py-2 hover:bg-gray-100 flex items-center" data-code="+41" data-flag="fi fi-ch" data-country="CH">
                                        <span class="fi fi-ch mr-3" style="width: 24px; height: 18px;"></span>
                                        <span class="flex-1">Suíça</span>
                                        <span class="text-sm text-gray-500">+41</span>
                                    </button>
                                    <button type="button" class="country-option w-full text-left px-3 py-2 hover:bg-gray-100 flex items-center" data-code="+43" data-flag="fi fi-at" data-country="AT">
                                        <span class="fi fi-at mr-3" style="width: 24px; height: 18px;"></span>
                                        <span class="flex-1">Áustria</span>
                                        <span class="text-sm text-gray-500">+43</span>
                                    </button>
                                    <button type="button" class="country-option w-full text-left px-3 py-2 hover:bg-gray-100 flex items-center" data-code="+45" data-flag="fi fi-dk" data-country="DK">
                                        <span class="fi fi-dk mr-3" style="width: 24px; height: 18px;"></span>
                                        <span class="flex-1">Dinamarca</span>
                                        <span class="text-sm text-gray-500">+45</span>
                                    </button>
                                    <button type="button" class="country-option w-full text-left px-3 py-2 hover:bg-gray-100 flex items-center" data-code="+46" data-flag="fi fi-se" data-country="SE">
                                        <span class="fi fi-se mr-3" style="width: 24px; height: 18px;"></span>
                                        <span class="flex-1">Suécia</span>
                                        <span class="text-sm text-gray-500">+46</span>
                                    </button>
                                    <button type="button" class="country-option w-full text-left px-3 py-2 hover:bg-gray-100 flex items-center" data-code="+47" data-flag="fi fi-no" data-country="NO">
                                        <span class="fi fi-no mr-3" style="width: 24px; height: 18px;"></span>
                                        <span class="flex-1">Noruega</span>
                                        <span class="text-sm text-gray-500">+47</span>
                                    </button>
                                    <button type="button" class="country-option w-full text-left px-3 py-2 hover:bg-gray-100 flex items-center" data-code="+358" data-flag="fi fi-fi" data-country="FI">
                                        <span class="fi fi-fi mr-3" style="width: 24px; height: 18px;"></span>
                                        <span class="flex-1">Finlândia</span>
                                        <span class="text-sm text-gray-500">+358</span>
                                    </button>
                                    <button type="button" class="country-option w-full text-left px-3 py-2 hover:bg-gray-100 flex items-center" data-code="+48" data-flag="fi fi-pl" data-country="PL">
                                        <span class="fi fi-pl mr-3" style="width: 24px; height: 18px;"></span>
                                        <span class="flex-1">Polónia</span>
                                        <span class="text-sm text-gray-500">+48</span>
                                    </button>
                                    <button type="button" class="country-option w-full text-left px-3 py-2 hover:bg-gray-100 flex items-center" data-code="+54" data-flag="fi fi-ar" data-country="AR">
                                        <span class="fi fi-ar mr-3" style="width: 24px; height: 18px;"></span>
                                        <span class="flex-1">Argentina</span>
                                        <span class="text-sm text-gray-500">+54</span>
                                    </button>
                                    <button type="button" class="country-option w-full text-left px-3 py-2 hover:bg-gray-100 flex items-center" data-code="+56" data-flag="fi fi-cl" data-country="CL">
                                        <span class="fi fi-cl mr-3" style="width: 24px; height: 18px;"></span>
                                        <span class="flex-1">Chile</span>
                                        <span class="text-sm text-gray-500">+56</span>
                                    </button>
                                    <button type="button" class="country-option w-full text-left px-3 py-2 hover:bg-gray-100 flex items-center" data-code="+57" data-flag="fi fi-co" data-country="CO">
                                        <span class="fi fi-co mr-3" style="width: 24px; height: 18px;"></span>
                                        <span class="flex-1">Colômbia</span>
                                        <span class="text-sm text-gray-500">+57</span>
                                    </button>
                                    <button type="button" class="country-option w-full text-left px-3 py-2 hover:bg-gray-100 flex items-center" data-code="+51" data-flag="fi fi-pe" data-country="PE">
                                        <span class="fi fi-pe mr-3" style="width: 24px; height: 18px;"></span>
                                        <span class="flex-1">Peru</span>
                                        <span class="text-sm text-gray-500">+51</span>
                                    </button>
                                    <button type="button" class="country-option w-full text-left px-3 py-2 hover:bg-gray-100 flex items-center" data-code="+52" data-flag="fi fi-mx" data-country="MX">
                                        <span class="fi fi-mx mr-3" style="width: 24px; height: 18px;"></span>
                                        <span class="flex-1">México</span>
                                        <span class="text-sm text-gray-500">+52</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Campo do número (oculto para usar no envio) -->
                        <input type="hidden" id="country-code" name="country_code" value="+351">
                        
                        <!-- Campo do número -->
                        <input id="telefone" name="telefone" type="tel" 
                               class="flex-1 border border-l-0 border-gray-300 rounded-r-md px-3 py-2 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" 
                               placeholder="912 345 678">
                    </div>
                    <p class="mt-1 text-xs text-gray-500">
                        Selecione o país e digite o número sem o código internacional (opcional)
                    </p>
                </div>

                <div>
                    <label for="farm-name" class="block text-sm font-medium text-gray-700">Nome da propriedade</label>
                    <input id="farm-name" name="farm-name" type="text" 
                           class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" 
                           placeholder="Nome da sua propriedade rural (opcional)">
                </div>

                <div>
                    <label for="location" class="block text-sm font-medium text-gray-700">
                        Localização <span class="text-red-500">*</span>
                    </label>
                    <div class="relative">
                        <input id="location" name="location" type="text" required
                               class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" 
                               placeholder="Ex: Lisboa ou Porto, Distrito do Porto"
                               autocomplete="off">
                        
                        <!-- Lista de sugestões -->
                        <div id="location-suggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg hidden max-h-60 overflow-y-auto">
                        </div>
                        
                        <!-- Indicador de status -->
                        <div id="location-status" class="mt-1 text-sm hidden">
                            <div id="location-loading" class="text-blue-600 hidden">
                                <i class="fas fa-spinner fa-spin"></i> Buscando localização...
                            </div>
                            <div id="location-success" class="text-green-600 hidden">
                                <i class="fas fa-check-circle"></i> <span id="location-success-text"></span>
                            </div>
                            <div id="location-error" class="text-red-600 hidden">
                                <i class="fas fa-exclamation-circle"></i> <span id="location-error-text"></span>
                            </div>
                        </div>
                        
                        <!-- Informações de coordenadas (ocultas) -->
                        <input type="hidden" id="latitude" name="latitude">
                        <input type="hidden" id="longitude" name="longitude">
                        <input type="hidden" id="formatted-address" name="formatted_address">
                    </div>
                    
                    <p class="mt-1 text-xs text-gray-500">
                        Digite sua cidade e distrito para que possamos fornecer informações climáticas precisas. 
                        Ex: "Lisboa" ou "Porto, Distrito do Porto"
                    </p>
                </div>
            </div>

            <div class="flex items-center">
                <input id="terms" name="terms" type="checkbox" required
                       class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded">
                <label for="terms" class="ml-2 block text-sm text-gray-900">
                    Eu aceito os 
                    <a href="#" class="text-green-600 hover:text-green-500">termos de serviço</a> 
                    e a 
                    <a href="#" class="text-green-600 hover:text-green-500">política de privacidade</a>
                </label>
            </div>

            <div>
                <button type="submit" 
                        class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    <span class="absolute left-0 inset-y-0 flex items-center pl-3">
                        <i class="fas fa-user-plus text-green-500 group-hover:text-green-400"></i>
                    </span>
                    Criar conta
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script nonce="{{ g.csp_nonce }}">
// Estado global para geocoding
let locationTimeout = null;
let selectedLocation = null;

// Validação de senha
document.getElementById('confirm-password').addEventListener('input', function() {
    const password = document.getElementById('password').value;
    const confirmPassword = this.value;
    
    if (password !== confirmPassword) {
        this.setCustomValidity('As senhas não coincidem');
    } else {
        this.setCustomValidity('');
    }
});

// Sistema de autocomplete para localização
function initLocationAutocomplete() {
    const locationInput = document.getElementById('location');
    const suggestionsDiv = document.getElementById('location-suggestions');
    const statusDiv = document.getElementById('location-status');
    const loadingDiv = document.getElementById('location-loading');
    const successDiv = document.getElementById('location-success');
    const errorDiv = document.getElementById('location-error');
    const successText = document.getElementById('location-success-text');
    const errorText = document.getElementById('location-error-text');
    
    // Campo de localização - busca com debounce
    locationInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();
        
        // Limpar timeout anterior
        if (locationTimeout) {
            clearTimeout(locationTimeout);
        }
        
        // Limpar estado anterior
        clearLocationStatus();
        selectedLocation = null;
        
        if (query.length < 3) {
            hideSuggestions();
            return;
        }
        
        // Mostrar loading
        showLocationStatus('loading');
        
        // Debounce de 500ms
        locationTimeout = setTimeout(() => {
            searchLocations(query);
        }, 500);
    });
    
    // Fechar sugestões ao clicar fora
    document.addEventListener('click', function(e) {
        if (!locationInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
            hideSuggestions();
        }
    });
    
    // Navegação por teclado nas sugestões
    locationInput.addEventListener('keydown', function(e) {
        const suggestions = suggestionsDiv.querySelectorAll('.suggestion-item');
        const activeSuggestion = suggestionsDiv.querySelector('.suggestion-item.active');
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            if (activeSuggestion) {
                activeSuggestion.classList.remove('active');
                const next = activeSuggestion.nextElementSibling || suggestions[0];
                next.classList.add('active');
            } else if (suggestions.length > 0) {
                suggestions[0].classList.add('active');
            }
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            if (activeSuggestion) {
                activeSuggestion.classList.remove('active');
                const prev = activeSuggestion.previousElementSibling || suggestions[suggestions.length - 1];
                prev.classList.add('active');
            } else if (suggestions.length > 0) {
                suggestions[suggestions.length - 1].classList.add('active');
            }
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (activeSuggestion) {
                selectLocation(JSON.parse(activeSuggestion.dataset.location));
            }
        } else if (e.key === 'Escape') {
            hideSuggestions();
        }
    });
}

// Buscar localizações
async function searchLocations(query) {
    try {
        const response = await fetch(`/api/geocoding/search?q=${encodeURIComponent(query)}&limit=5`);
        const data = await response.json();
        
        clearLocationStatus();
        
        if (data.success && data.suggestions && data.suggestions.length > 0) {
            showSuggestions(data.suggestions);
        } else {
            hideSuggestions();
            showLocationStatus('error', 'Nenhuma localização encontrada. Tente ser mais específico.');
        }
    } catch (error) {
        clearLocationStatus();
        showLocationStatus('error', 'Erro ao buscar localizações. Verifique sua conexão.');
        hideSuggestions();
    }
}

// Mostrar sugestões
function showSuggestions(suggestions) {
    const suggestionsDiv = document.getElementById('location-suggestions');
    suggestionsDiv.innerHTML = '';
    
    suggestions.forEach(suggestion => {
        const item = document.createElement('div');
        item.className = 'suggestion-item px-3 py-2 cursor-pointer hover:bg-gray-100 border-b border-gray-200 last:border-b-0';
        item.dataset.location = JSON.stringify(suggestion);
        
        item.innerHTML = `
            <div class="font-medium text-gray-900">${suggestion.display_name}</div>
            <div class="text-sm text-gray-500">${suggestion.full_address}</div>
        `;
        
        item.addEventListener('click', () => selectLocation(suggestion));
        suggestionsDiv.appendChild(item);
    });
    
    suggestionsDiv.classList.remove('hidden');
}

// Esconder sugestões
function hideSuggestions() {
    const suggestionsDiv = document.getElementById('location-suggestions');
    suggestionsDiv.classList.add('hidden');
    suggestionsDiv.innerHTML = '';
}

// Selecionar localização
function selectLocation(location) {
    selectedLocation = location;
    
    // Preencher campos
    document.getElementById('location').value = location.full_address;
    document.getElementById('latitude').value = location.latitude;
    document.getElementById('longitude').value = location.longitude;
    document.getElementById('formatted-address').value = location.full_address;
    
    // Mostrar sucesso
    showLocationStatus('success', `Localização confirmada: ${location.full_address}`);
    
    hideSuggestions();
}

// Gerenciar status da localização
function showLocationStatus(type, message = '') {
    const statusDiv = document.getElementById('location-status');
    const loadingDiv = document.getElementById('location-loading');
    const successDiv = document.getElementById('location-success');
    const errorDiv = document.getElementById('location-error');
    const successText = document.getElementById('location-success-text');
    const errorText = document.getElementById('location-error-text');
    
    statusDiv.classList.remove('hidden');
    
    // Esconder todos
    loadingDiv.classList.add('hidden');
    successDiv.classList.add('hidden');
    errorDiv.classList.add('hidden');
    
    // Mostrar específico
    if (type === 'loading') {
        loadingDiv.classList.remove('hidden');
    } else if (type === 'success') {
        successDiv.classList.remove('hidden');
        successText.textContent = message;
    } else if (type === 'error') {
        errorDiv.classList.remove('hidden');
        errorText.textContent = message;
    }
}

function clearLocationStatus() {
    const statusDiv = document.getElementById('location-status');
    statusDiv.classList.add('hidden');
}

// Verificar se é uma cidade principal portuguesa que não precisa de distrito
function isMainCity(city) {
    const mainCities = [
        'lisboa', 'porto', 'braga', 'coimbra', 'faro', 'aveiro',
        'viseu', 'setúbal', 'leiria', 'vila nova de gaia', 'funchal',
        'ponta delgada', 'évora', 'beja', 'viana do castelo',
        'guarda', 'castelo branco', 'portalegre', 'santarém'
    ];
    return mainCities.includes(city.toLowerCase().trim());
}

// Validação do formulário
function validateLocationForm() {
    const locationInput = document.getElementById('location');
    const location = locationInput.value.trim();
    
    if (!location) {
        showLocationStatus('error', 'Localização é obrigatória');
        locationInput.focus();
        return false;
    }
    
    if (location.length < 3) {
        showLocationStatus('error', 'Localização deve ter pelo menos 3 caracteres');
        locationInput.focus();
        return false;
    }
    
    // Verificar se tem vírgula (formato cidade, distrito) ou é uma cidade principal
    if (!location.includes(',') && location.split(' ').length < 2 && !isMainCity(location)) {
        showLocationStatus('error', 'Use formato "Cidade" ou "Cidade, Distrito" (ex: Lisboa ou Porto, Distrito do Porto)');
        locationInput.focus();
        return false;
    }
    
    return true;
}

// Sistema de telefone com código de país
function initPhoneSystem() {
    const countryDropdownButton = document.getElementById('country-dropdown-button');
    const countryDropdownMenu = document.getElementById('country-dropdown-menu');
    const selectedCountrySpan = document.getElementById('selected-country');
    const countryCodeInput = document.getElementById('country-code');
    const phoneInput = document.getElementById('telefone');
    
    // Toggle dropdown
    countryDropdownButton.addEventListener('click', function(e) {
        e.preventDefault();
        countryDropdownMenu.classList.toggle('hidden');
    });
    
    // Fechar dropdown ao clicar fora
    document.addEventListener('click', function(e) {
        if (!countryDropdownButton.contains(e.target) && !countryDropdownMenu.contains(e.target)) {
            countryDropdownMenu.classList.add('hidden');
        }
    });
    
    // Selecionar país
    const countryOptions = document.querySelectorAll('.country-option');
    countryOptions.forEach(option => {
        option.addEventListener('click', function() {
            const code = this.dataset.code;
            const flag = this.dataset.flag;
            const country = this.dataset.country;
            
            // Atualizar display
            selectedCountrySpan.innerHTML = `
                <span class="${flag} mr-1" style="width: 20px; height: 15px;"></span>
                <span class="text-xs">${code}</span>
            `;
            
            // Atualizar valor oculto
            countryCodeInput.value = code;
            
            // Fechar dropdown
            countryDropdownMenu.classList.add('hidden');
            
            // Atualizar placeholder e reformatar número
            updatePhonePlaceholder(code);
            
            // Reformatar número existente
            if (phoneInput.value) {
                const cleanValue = phoneInput.value.replace(/\D/g, '');
                phoneInput.value = cleanValue;
                phoneInput.dispatchEvent(new Event('input'));
            }
        });
    });
    
    // Formatação automática do número de telefone
    phoneInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, ''); // Remove não dígitos
        const countryCode = countryCodeInput.value;
        
        // Formatação específica por país
        if (countryCode === '+351') { // Portugal
            // Formato: 912 345 678 ou 212 345 678
            if (value.length >= 6) {
                value = value.replace(/(\d{3})(\d{3})(\d{3})/, '$1 $2 $3');
            } else if (value.length >= 3) {
                value = value.replace(/(\d{3})(\d{3})/, '$1 $2');
            }
        } else if (countryCode === '+55') { // Brasil
            // Formato: (11) 99999-9999
            if (value.length >= 11) {
                value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            } else if (value.length >= 7) {
                value = value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
            } else if (value.length >= 3) {
                value = value.replace(/(\d{2})(\d{4})/, '($1) $2');
            }
        } else if (countryCode === '+1') { // EUA/Canadá
            // Formato: (555) 123-4567
            if (value.length >= 10) {
                value = value.replace(/(\d{3})(\d{3})(\d{4})/, '($1) $2-$3');
            } else if (value.length >= 6) {
                value = value.replace(/(\d{3})(\d{3})/, '($1) $2');
            }
        } else if (countryCode === '+34') { // Espanha
            // Formato: 612 34 56 78
            if (value.length >= 9) {
                value = value.replace(/(\d{3})(\d{2})(\d{2})(\d{2})/, '$1 $2 $3 $4');
            } else if (value.length >= 6) {
                value = value.replace(/(\d{3})(\d{2})(\d{2})/, '$1 $2 $3');
            }
        } else if (countryCode === '+33') { // França
            // Formato: 06 12 34 56 78
            if (value.length >= 10) {
                value = value.replace(/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/, '$1 $2 $3 $4 $5');
            } else if (value.length >= 6) {
                value = value.replace(/(\d{2})(\d{2})(\d{2})/, '$1 $2 $3');
            }
        } else {
            // Formatação genérica para outros países
            if (value.length >= 6) {
                value = value.replace(/(\d{3})(\d{3})(\d+)/, '$1 $2 $3');
            }
        }
        
        e.target.value = value;
    });
    
    // Função para atualizar placeholder
    function updatePhonePlaceholder(countryCode) {
        const placeholders = {
            '+351': '912 345 678',
            '+34': '612 34 56 78',
            '+33': '06 12 34 56 78',
            '+49': '0151 23456789',
            '+39': '312 345 6789',
            '+44': '07123 456789',
            '+1': '(555) 123-4567',
            '+55': '(11) 99999-9999',
            '+54': '11 1234-5678',
            '+56': '9 1234 5678',
            '+57': '321 123 4567',
            '+51': '987 654 321',
            '+52': '55 1234 5678',
            '+31': '06 12345678',
            '+32': '0470 12 34 56',
            '+41': '078 123 45 67',
            '+43': '0664 123456',
            '+45': '20 12 34 56',
            '+46': '070-123 45 67',
            '+47': '406 12 345',
            '+358': '040 123 4567',
            '+48': '512 345 678'
        };
        
        phoneInput.placeholder = placeholders[countryCode] || '123 456 789';
    }
    
    // Combinar código do país + número no submit
    const form = document.querySelector('form[action*="register"]');
    if (form) {
        form.addEventListener('submit', function(e) {
            const countryCode = countryCodeInput.value;
            const phoneNumber = phoneInput.value.replace(/\D/g, ''); // Remove formatação
            
            if (phoneNumber) {
                // Criar campo oculto com telefone completo
                const fullPhoneInput = document.createElement('input');
                fullPhoneInput.type = 'hidden';
                fullPhoneInput.name = 'telefone_completo';
                fullPhoneInput.value = countryCode + phoneNumber;
                form.appendChild(fullPhoneInput);
            }
        });
    }
}

// Inicializar ao carregar a página
document.addEventListener('DOMContentLoaded', function() {
    initLocationAutocomplete();
    initPhoneSystem();
    
    // Validação no submit do formulário principal
    const mainForm = document.querySelector('form[action*="register"]');
    if (mainForm) {
        mainForm.addEventListener('submit', function(e) {
            if (!validateLocationForm()) {
                e.preventDefault();
                return false;
            }
        });
    }
});
</script>
{% endblock %}
